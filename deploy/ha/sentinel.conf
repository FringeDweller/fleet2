# Redis Sentinel Configuration for Fleet2 High Availability
#
# Redis Sentinel provides high availability for Redis through:
# - Monitoring: Sentinel constantly checks if master and replicas are working
# - Notification: Sentinel can notify system administrators about Redis issues
# - Automatic failover: If master fails, Sentinel promotes a replica to master
# - Configuration provider: Clients connect to Sentinel to get current master
#
# Documentation: https://redis.io/docs/management/sentinel/

# =============================================================================
# SENTINEL SETTINGS
# =============================================================================

# Port for this Sentinel instance
# Default: 26379
port 26379

# Sentinel ID (auto-generated if not set)
# Each Sentinel needs a unique ID
# sentinel myid <40_char_hex_string>

# Working directory
dir /data

# Log level: debug, verbose, notice, warning
loglevel notice

# Log file (empty = stdout, useful for Docker)
logfile ""

# =============================================================================
# MASTER MONITORING
# =============================================================================

# Sentinel monitor configuration
# sentinel monitor <master-name> <ip> <port> <quorum>
#
# - master-name: Name for this master (used by clients)
# - ip: Master's IP or hostname
# - port: Master's port
# - quorum: Number of Sentinels needed to agree master is down
#
# For Fleet2, we monitor one master named "fleet-redis"
sentinel monitor fleet-redis redis-primary 6379 2

# =============================================================================
# AUTHENTICATION
# =============================================================================

# Password to use when connecting to master/replicas
# Must match requirepass and masterauth in Redis configuration
sentinel auth-pass fleet-redis redis_secret_password

# Password for Sentinel clients (optional, but recommended)
# sentinel sentinel-pass <password>

# =============================================================================
# TIMING SETTINGS
# =============================================================================

# Milliseconds before considering master down (subjectively)
# After this time without response, Sentinel marks master as S_DOWN
# Default: 30000 (30 seconds)
sentinel down-after-milliseconds fleet-redis 10000

# Failover timeout in milliseconds
# This is used for:
# - Time to retry failover after a previous failover attempt failed
# - Time for replica to replicate from new master after failover
# - Time to cancel an in-progress failover
# Default: 180000 (3 minutes)
sentinel failover-timeout fleet-redis 60000

# Number of replicas that can be reconfigured simultaneously during failover
# Lower values = slower failover but less load on network
# Default: 1
sentinel parallel-syncs fleet-redis 1

# =============================================================================
# NOTIFICATION SCRIPTS (Optional)
# =============================================================================

# Script executed when master changes (failover)
# Arguments: <master-name> <role> <state> <from-ip> <from-port> <to-ip> <to-port>
# sentinel notification-script fleet-redis /scripts/notify.sh

# Script executed when any important event happens
# Arguments: <event-type> <event-description>
# sentinel client-reconfig-script fleet-redis /scripts/reconfig.sh

# =============================================================================
# NETWORKING
# =============================================================================

# Bind address (0.0.0.0 = all interfaces)
bind 0.0.0.0

# Protected mode (disable for Docker networking)
# When enabled, Sentinel only accepts loopback connections unless password set
protected-mode no

# TCP backlog
tcp-backlog 511

# =============================================================================
# CLUSTER SETTINGS
# =============================================================================

# Announce IP/port for NAT/Docker environments
# If running in Docker with different internal/external addresses
# sentinel announce-ip <ip>
# sentinel announce-port <port>

# Require Sentinel quorum for failover
# This is set in the monitor command above (quorum = 2)
# Meaning 2 out of 3 Sentinels must agree to trigger failover

# Deny scripts directory (security)
# Prevents running scripts from this directory
# sentinel deny-scripts-reconfig yes

# =============================================================================
# ACL (Access Control Lists) - Redis 6.0+
# =============================================================================

# Uncomment to enable ACL for Sentinel
# aclfile /etc/redis/sentinel-acl.conf

# Or use inline ACL rules:
# user default on nopass ~* &* +@all

# =============================================================================
# ADVANCED SETTINGS
# =============================================================================

# Replica priority (lower = higher priority to become master)
# Set on replicas, not Sentinel. But Sentinel respects this during failover
# Default: 100, 0 = never promote to master
# replica-priority 100

# Sentinel can refuse writes if not enough replicas are connected
# (This is configured on the master, not Sentinel)
# min-replicas-to-write 1
# min-replicas-max-lag 10

# =============================================================================
# NOTES FOR PRODUCTION
# =============================================================================
#
# 1. QUORUM CONFIGURATION:
#    - Always use odd number of Sentinels (3, 5, 7)
#    - Quorum should be majority: (N/2)+1
#    - For 3 Sentinels: quorum=2
#    - For 5 Sentinels: quorum=3
#
# 2. NETWORK CONSIDERATIONS:
#    - Deploy Sentinels on different physical/virtual machines
#    - Avoid all Sentinels on same network partition
#    - Consider cross-datacenter deployment for DR
#
# 3. CLIENT CONFIGURATION:
#    - Clients should connect to Sentinel first to get master address
#    - Most Redis clients support Sentinel mode
#    - Example (Node.js ioredis):
#      ```
#      const redis = new Redis({
#        sentinels: [
#          { host: 'sentinel1', port: 26379 },
#          { host: 'sentinel2', port: 26379 },
#          { host: 'sentinel3', port: 26379 }
#        ],
#        name: 'fleet-redis',
#        password: 'redis_secret_password'
#      });
#      ```
#
# 4. MONITORING:
#    - Monitor Sentinel logs for failover events
#    - Use SENTINEL commands for cluster status:
#      - SENTINEL masters
#      - SENTINEL master fleet-redis
#      - SENTINEL replicas fleet-redis
#      - SENTINEL sentinels fleet-redis
#      - SENTINEL ckquorum fleet-redis
#
# 5. MANUAL FAILOVER:
#    - SENTINEL failover fleet-redis
#    - Triggers controlled failover (useful for maintenance)
#
# 6. TROUBLESHOOTING:
#    - Check if quorum is reachable: SENTINEL ckquorum fleet-redis
#    - Verify master: SENTINEL get-master-addr-by-name fleet-redis
#    - Check replica status: SENTINEL replicas fleet-redis
