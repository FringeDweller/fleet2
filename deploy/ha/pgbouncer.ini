; PgBouncer Configuration for Fleet2 High Availability
;
; PgBouncer provides connection pooling between the application and PostgreSQL,
; significantly reducing connection overhead and improving performance.
;
; This configuration supports:
; - Transaction-mode pooling (recommended for most applications)
; - Connection limits and timeouts
; - Query timeouts for safety
; - Statistics for monitoring
;
; Documentation: https://www.pgbouncer.org/config.html

; =============================================================================
; DATABASE CONFIGURATION
; =============================================================================

[databases]

; Primary database connection (for writes)
; Connects to HAProxy which routes to Patroni primary
; The host/port are overridden by environment variables in Docker
fleet = host=haproxy-pg port=5433 dbname=fleet auth_user=fleet

; Read replica connection (optional - for read scaling)
; Connects to HAProxy which load balances across replicas
fleet_readonly = host=haproxy-pg port=5434 dbname=fleet auth_user=fleet

; Wildcard entry - forward all other database requests to primary
; This allows connecting to system databases like postgres
* = host=haproxy-pg port=5433 auth_user=fleet

; =============================================================================
; PGBOUNCER SETTINGS
; =============================================================================

[pgbouncer]

; -----------------------------------------------------------------------------
; Connection Settings
; -----------------------------------------------------------------------------

; Address to listen on
; 0.0.0.0 = all interfaces, * = all addresses including Unix socket
listen_addr = 0.0.0.0

; Port to listen on (default: 6432)
listen_port = 6432

; Unix socket directory (optional - disabled in Docker typically)
; unix_socket_dir = /var/run/pgbouncer

; Unix socket file mode
; unix_socket_mode = 0777

; -----------------------------------------------------------------------------
; Authentication Settings
; -----------------------------------------------------------------------------

; Authentication method for clients
; Options: hba, cert, md5, scram-sha-256, plain, trust, any
; - md5: Traditional PostgreSQL password auth (compatible)
; - scram-sha-256: More secure, PostgreSQL 10+
; - hba: Use pg_hba.conf style rules from auth_hba_file
auth_type = md5

; File containing userlist (user/password pairs)
; Format: "username" "md5hash_or_plain_password"
; If using environment variables, this may not be needed
auth_file = /opt/bitnami/pgbouncer/conf/userlist.txt

; Query to fetch user credentials from PostgreSQL
; Useful for dynamic user management (requires auth_user in database config)
auth_query = SELECT usename, passwd FROM pg_shadow WHERE usename=$1

; User for auth_query - must be superuser or have pg_shadow access
; This is set in the [databases] section

; HBA-style authentication file (when auth_type = hba)
; auth_hba_file = /etc/pgbouncer/pg_hba.conf

; -----------------------------------------------------------------------------
; Pool Configuration
; -----------------------------------------------------------------------------

; Pool mode determines how connections are reused:
; - session: Connection is returned to pool when client disconnects (default)
; - transaction: Connection is returned after each transaction (recommended)
; - statement: Connection is returned after each statement (limited use cases)
pool_mode = transaction

; Maximum number of client connections allowed
max_client_conn = 500

; Default pool size per user/database pair
; This is the number of server connections kept open
default_pool_size = 25

; Minimum pool size per user/database pair
; PgBouncer will keep at least this many connections open
min_pool_size = 5

; Reserve pool size - extra connections for emergencies
; Used when all regular connections are in use
reserve_pool_size = 5

; How long to wait before using reserve pool connections (seconds)
reserve_pool_timeout = 3

; Maximum per-database connections (0 = unlimited)
max_db_connections = 100

; Maximum per-user connections (0 = unlimited)
max_user_connections = 100

; -----------------------------------------------------------------------------
; Timeouts
; -----------------------------------------------------------------------------

; Server connection idle timeout (seconds)
; Close unused server connections after this time
server_idle_timeout = 300

; Server connection lifetime (seconds)
; Close server connections older than this, even if still valid
; Helps rotate connections and refresh DNS
server_lifetime = 3600

; Server connection timeout (seconds)
; Time to wait for server connection to be established
server_connect_timeout = 15

; Server login timeout (seconds)
; Time allowed for login packet exchange
server_login_retry = 3

; Client idle timeout (seconds)
; Disconnect idle clients (transaction mode respects transaction boundaries)
; 0 = disabled
client_idle_timeout = 300

; Client login timeout (seconds)
; Time allowed for client to authenticate
client_login_timeout = 60

; Query timeout (seconds)
; Disconnect client if query runs longer than this
; 0 = disabled (not recommended for production)
query_timeout = 300

; Query wait timeout (seconds)
; How long queries can wait for a server connection
; If timeout is reached, query is canceled
query_wait_timeout = 120

; Cancel wait timeout (seconds)
; How long to wait when sending cancel request to server
cancel_wait_timeout = 10

; Idle transaction timeout (seconds)
; Kill connection if transaction is idle for too long
; Helps prevent connection hogging in transaction pool mode
idle_transaction_timeout = 300

; -----------------------------------------------------------------------------
; Logging
; -----------------------------------------------------------------------------

; Log file location (stdout in Docker)
; logfile = /var/log/pgbouncer/pgbouncer.log

; Syslog facility (optional)
; syslog = 0
; syslog_facility = daemon
; syslog_ident = pgbouncer

; Log level: debug, info, log, notice, warning, error
; log_level = log

; Log connections (useful for debugging)
log_connections = 1

; Log disconnections
log_disconnections = 1

; Log pooler errors
log_pooler_errors = 1

; Include stats in log (period in seconds, 0 = disabled)
stats_period = 60

; Verbose mode - log parameter values in queries
; WARNING: May log sensitive data
verbose = 0

; -----------------------------------------------------------------------------
; Console Access (Admin Interface)
; -----------------------------------------------------------------------------

; Admin users who can connect to pgbouncer database for admin commands
admin_users = fleet

; Users allowed to run read-only admin commands (SHOW commands)
stats_users = fleet

; -----------------------------------------------------------------------------
; Networking
; -----------------------------------------------------------------------------

; TCP keepalive settings (seconds)
tcp_keepalive = 1
tcp_keepidle = 30
tcp_keepintvl = 10
tcp_keepcnt = 3

; TCP socket options
; tcp_defer_accept = 1  ; Linux only

; DNS lookup caching (seconds)
; 0 = system default, -1 = infinite
dns_max_ttl = 15
dns_zone_check_period = 0

; Resolve hostnames at connection time
dns_nxdomain_ttl = 15

; -----------------------------------------------------------------------------
; TLS/SSL Settings (Optional)
; -----------------------------------------------------------------------------

; Server-side TLS (clients connecting to PgBouncer)
; server_tls_sslmode = prefer
; server_tls_ca_file = /etc/pgbouncer/ca.crt
; server_tls_cert_file = /etc/pgbouncer/server.crt
; server_tls_key_file = /etc/pgbouncer/server.key
; server_tls_ciphers = HIGH:!ADH:!AECDH:!LOW:!EXP:!MD5:!3DES:!SRP:!PSK:@STRENGTH
; server_tls_protocols = secure

; Client-side TLS (PgBouncer connecting to PostgreSQL)
; client_tls_sslmode = prefer
; client_tls_ca_file = /etc/pgbouncer/ca.crt
; client_tls_cert_file = /etc/pgbouncer/client.crt
; client_tls_key_file = /etc/pgbouncer/client.key
; client_tls_ciphers = HIGH:!ADH:!AECDH:!LOW:!EXP:!MD5:!3DES:!SRP:!PSK:@STRENGTH
; client_tls_protocols = secure

; -----------------------------------------------------------------------------
; Low-level Settings
; -----------------------------------------------------------------------------

; Disable pipelining - compatibility with older applications
disable_pipelining = 0

; Application name to set on server connections
application_name_add_host = 1

; Backend connection startup parameters to ignore
ignore_startup_parameters = extra_float_digits

; Track prepared statements (required for some ORMs in session mode)
; max_prepared_statements = 100

; Socket buffer sizes (0 = system default)
pkt_buf = 4096
sbuf_lookahead = 0

; SO_REUSEPORT option (Linux 3.9+)
; so_reuseport = 0

; =============================================================================
; USER LIST
; =============================================================================

; The userlist.txt file should contain user credentials:
; "username" "password_or_md5hash"
;
; Example format:
; "fleet" "md5abc123..."
; "replicator" "md5def456..."
;
; To generate MD5 hash:
; echo -n 'passwordusername' | md5sum | awk '{print "md5"$1}'
;
; For SCRAM-SHA-256 (PostgreSQL 10+), use:
; "username" "SCRAM-SHA-256$..."
