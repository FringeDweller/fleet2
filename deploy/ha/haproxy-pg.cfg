# HAProxy Configuration for PostgreSQL Cluster Routing
#
# This configuration provides:
# - Automatic primary detection via Patroni REST API
# - Read/write split (primary on port 5433, replicas on port 5434)
# - Health checking and automatic failover awareness
# - Connection load balancing for read replicas
#
# Documentation: https://www.haproxy.com/documentation/haproxy-configuration-manual/

# =============================================================================
# GLOBAL SETTINGS
# =============================================================================

global
    # Maximum concurrent connections
    maxconn 2000

    # Logging configuration
    # In Docker, use stdout for compatibility with container logging
    log stdout format raw local0 info

    # User/group (uncomment for non-root operation)
    # user haproxy
    # group haproxy

    # Stats socket for runtime API
    stats socket /tmp/haproxy.sock mode 600 level admin
    stats timeout 30s

    # SSL settings (if using SSL termination)
    # ssl-default-bind-ciphers ECDHE+AESGCM:DHE+AESGCM:ECDHE+CHACHA20:DHE+CHACHA20:ECDHE+RSA+AES128:!aNULL:!MD5:!DSS
    # ssl-default-bind-options ssl-min-ver TLSv1.2

# =============================================================================
# DEFAULT SETTINGS
# =============================================================================

defaults
    # Mode for PostgreSQL (TCP layer 4)
    mode tcp

    # Logging
    log global
    option tcplog

    # Timeouts
    # Client inactivity timeout
    timeout client 30m

    # Server connection timeout
    timeout connect 10s

    # Server inactivity timeout
    timeout server 30m

    # Queue timeout (time to wait for a free server slot)
    timeout queue 1m

    # Health check timeout
    timeout check 5s

    # Retry settings
    retries 3

    # Options
    option redispatch
    option tcp-check

# =============================================================================
# STATISTICS AND MONITORING
# =============================================================================

# Stats dashboard (accessible at http://haproxy:8404/stats)
frontend stats
    mode http
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats show-node
    # Uncomment for authentication (recommended in production)
    # stats auth admin:admin_password
    # stats admin if TRUE

# Health check endpoint for container health checks
frontend health
    mode http
    bind *:8405
    monitor-uri /health
    option httplog

# =============================================================================
# POSTGRESQL PRIMARY (READ/WRITE)
# =============================================================================

# Frontend for primary PostgreSQL connections (writes)
frontend pg_primary
    # Listen on port 5433 for primary connections
    bind *:5433

    # Default backend for primary
    default_backend pg_primary_backend

# Backend for PostgreSQL primary
# Uses Patroni REST API to detect current leader
backend pg_primary_backend
    # TCP mode for PostgreSQL
    mode tcp

    # Health check using Patroni REST API
    # Returns 200 only for the current primary
    option httpchk GET /primary
    http-check expect status 200

    # Balance mode (not really used since only one primary)
    balance first

    # Server definitions with health checks
    # The httpchk port (8008) is Patroni REST API
    server patroni1 patroni1:5432 check port 8008 inter 3s fall 3 rise 2 maxconn 200
    server patroni2 patroni2:5432 check port 8008 inter 3s fall 3 rise 2 maxconn 200
    server patroni3 patroni3:5432 check port 8008 inter 3s fall 3 rise 2 maxconn 200

# =============================================================================
# POSTGRESQL REPLICAS (READ-ONLY)
# =============================================================================

# Frontend for replica PostgreSQL connections (reads)
frontend pg_replica
    # Listen on port 5434 for replica connections
    bind *:5434

    # Default backend for replicas
    default_backend pg_replica_backend

# Backend for PostgreSQL replicas
# Uses Patroni REST API to detect healthy replicas
backend pg_replica_backend
    # TCP mode for PostgreSQL
    mode tcp

    # Health check using Patroni REST API
    # Returns 200 for healthy replicas (or primary if no replicas)
    option httpchk GET /replica
    http-check expect status 200

    # Balance mode for read distribution
    # roundrobin: Equal distribution
    # leastconn: Route to server with fewest connections (recommended)
    balance leastconn

    # Server definitions with health checks
    # Lower weight servers are used less often
    server patroni1 patroni1:5432 check port 8008 inter 3s fall 3 rise 2 maxconn 500 weight 1
    server patroni2 patroni2:5432 check port 8008 inter 3s fall 3 rise 2 maxconn 500 weight 10
    server patroni3 patroni3:5432 check port 8008 inter 3s fall 3 rise 2 maxconn 500 weight 10

# =============================================================================
# POSTGRESQL SYNC REPLICAS (Optional - for synchronous reads)
# =============================================================================

# Uncomment if you need to route only to synchronous replicas
# frontend pg_sync
#     bind *:5435
#     default_backend pg_sync_backend
#
# backend pg_sync_backend
#     mode tcp
#     option httpchk GET /sync
#     http-check expect status 200
#     balance leastconn
#     server patroni1 patroni1:5432 check port 8008 inter 3s fall 3 rise 2 maxconn 200
#     server patroni2 patroni2:5432 check port 8008 inter 3s fall 3 rise 2 maxconn 200
#     server patroni3 patroni3:5432 check port 8008 inter 3s fall 3 rise 2 maxconn 200

# =============================================================================
# PATRONI REST API PROXY (Optional)
# =============================================================================

# Uncomment to expose Patroni REST API via HAProxy
# frontend patroni_api
#     mode http
#     bind *:8080
#     default_backend patroni_api_backend
#
# backend patroni_api_backend
#     mode http
#     option httpchk GET /health
#     balance roundrobin
#     server patroni1 patroni1:8008 check inter 3s
#     server patroni2 patroni2:8008 check inter 3s
#     server patroni3 patroni3:8008 check inter 3s

# =============================================================================
# NOTES
# =============================================================================
#
# Patroni REST API Endpoints used for health checks:
#
# /primary     - Returns 200 if node is the current primary
# /replica     - Returns 200 if node is a healthy replica (or primary)
# /sync        - Returns 200 if node is a synchronous replica
# /async       - Returns 200 if node is an asynchronous replica
# /health      - Returns 200 if node is healthy (regardless of role)
# /read-only   - Returns 200 if node is suitable for read-only queries
# /read-write  - Returns 200 if node accepts writes (same as /primary)
#
# Connection limits:
# - Primary: Lower maxconn (200) to protect write capacity
# - Replicas: Higher maxconn (500) to handle more read traffic
#
# Health check timing:
# - inter 3s: Check every 3 seconds
# - fall 3: Mark unhealthy after 3 consecutive failures
# - rise 2: Mark healthy after 2 consecutive successes
#
# Weight:
# - Primary (patroni1) has weight=1 in replica backend
#   This means it only receives read traffic if all replicas are down
# - Replicas have weight=10 for normal read distribution
