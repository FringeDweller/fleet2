# etcd Cluster Configuration for Fleet2 High Availability
#
# This file contains environment variables for the etcd cluster used by Patroni
# for distributed consensus and leader election.
#
# etcd provides:
# - Distributed key-value store for cluster state
# - Leader election for PostgreSQL failover
# - Configuration storage for Patroni
#
# Documentation: https://etcd.io/docs/

# =============================================================================
# CLUSTER CONFIGURATION
# =============================================================================

# Cluster token - unique identifier for this cluster
# All nodes in the same cluster must use the same token
# Change this for each new cluster deployment!
ETCD_INITIAL_CLUSTER_TOKEN=fleet-etcd-cluster-token-v1

# Initial cluster state
# Options:
# - new: Creating a new cluster
# - existing: Joining an existing cluster
ETCD_INITIAL_CLUSTER_STATE=new

# Initial cluster members
# Format: name1=http://host1:2380,name2=http://host2:2380,...
# This must include all etcd nodes in the cluster
ETCD_INITIAL_CLUSTER=etcd1=http://etcd1:2380,etcd2=http://etcd2:2380,etcd3=http://etcd3:2380

# =============================================================================
# DATA CONFIGURATION
# =============================================================================

# Data directory for etcd storage
# This should be a persistent volume in production
ETCD_DATA_DIR=/etcd-data

# WAL directory (optional - defaults to data dir)
# For better performance, use a separate fast disk
# ETCD_WAL_DIR=/etcd-wal

# Snapshot count - number of transactions before snapshot
# Lower values = more frequent snapshots = faster recovery but more I/O
ETCD_SNAPSHOT_COUNT=10000

# Maximum number of snapshots to retain
ETCD_MAX_SNAPSHOTS=5

# Maximum number of WAL files to retain
ETCD_MAX_WALS=5

# =============================================================================
# TIMEOUTS AND INTERVALS
# =============================================================================

# Heartbeat interval in milliseconds
# Leader sends heartbeats at this interval
ETCD_HEARTBEAT_INTERVAL=100

# Election timeout in milliseconds
# Must be 5-10x heartbeat interval
# If no heartbeat received within this time, trigger election
ETCD_ELECTION_TIMEOUT=1000

# =============================================================================
# QUOTAS AND LIMITS
# =============================================================================

# Backend quota in bytes (default: 2GB, max: 8GB)
# This is the maximum size of the etcd database
# For Fleet2, 2GB should be more than sufficient
ETCD_QUOTA_BACKEND_BYTES=2147483648

# Auto compaction mode
# Options: periodic, revision
# periodic: Compact every X hours/minutes
# revision: Keep last N revisions
ETCD_AUTO_COMPACTION_MODE=periodic

# Auto compaction retention
# For periodic: duration like "1h" or "24h"
# For revision: number of revisions to keep
ETCD_AUTO_COMPACTION_RETENTION=1h

# =============================================================================
# LOGGING
# =============================================================================

# Log level: debug, info, warn, error, panic, fatal
ETCD_LOG_LEVEL=info

# Log output: stderr, stdout, or file path
ETCD_LOG_OUTPUTS=stderr

# Enable log rotation (requires file output)
# ETCD_LOG_ROTATION=true

# =============================================================================
# SECURITY (Optional - Enable for Production)
# =============================================================================

# Client TLS settings
# Uncomment and configure for secure client connections
# ETCD_CERT_FILE=/etc/etcd/ssl/server.crt
# ETCD_KEY_FILE=/etc/etcd/ssl/server.key
# ETCD_CLIENT_CERT_AUTH=true
# ETCD_TRUSTED_CA_FILE=/etc/etcd/ssl/ca.crt

# Peer TLS settings
# Uncomment and configure for secure peer connections
# ETCD_PEER_CERT_FILE=/etc/etcd/ssl/peer.crt
# ETCD_PEER_KEY_FILE=/etc/etcd/ssl/peer.key
# ETCD_PEER_CLIENT_CERT_AUTH=true
# ETCD_PEER_TRUSTED_CA_FILE=/etc/etcd/ssl/ca.crt

# Auto TLS (for testing/development only)
# etcd will automatically generate self-signed certificates
# ETCD_AUTO_TLS=true
# ETCD_PEER_AUTO_TLS=true

# =============================================================================
# AUTHENTICATION (Optional)
# =============================================================================

# Enable authentication (requires TLS for production)
# After enabling, you must create root user via etcdctl
# ETCD_AUTH_TOKEN=simple

# =============================================================================
# METRICS
# =============================================================================

# Enable metrics endpoint for Prometheus scraping
# Metrics available at http://etcd:2379/metrics
ETCD_LISTEN_METRICS_URLS=http://0.0.0.0:2381

# =============================================================================
# DEBUGGING (Disable in Production)
# =============================================================================

# Enable debug logging
# ETCD_DEBUG=false

# Enable pprof profiling endpoints
# ETCD_ENABLE_PPROF=false

# Enable v2 API (deprecated, disable unless needed)
# ETCD_ENABLE_V2=false

# =============================================================================
# PERFORMANCE TUNING
# =============================================================================

# Max concurrent streams per HTTP/2 connection
# ETCD_MAX_CONCURRENT_STREAMS=100

# GRPC keepalive settings
# ETCD_GRPC_KEEPALIVE_MIN_TIME=5s
# ETCD_GRPC_KEEPALIVE_INTERVAL=2h
# ETCD_GRPC_KEEPALIVE_TIMEOUT=20s

# =============================================================================
# CLUSTER HEALTH
# =============================================================================

# Strict reconfig check
# Ensures cluster health before accepting reconfiguration
ETCD_STRICT_RECONFIG_CHECK=true

# Enable learner mode for new members
# New members start as learners (non-voting) until promoted
# ETCD_INITIAL_CLUSTER_LEARNER_MODE=false

# Pre-vote - reduces disruption during network partitions
ETCD_PRE_VOTE=true

# =============================================================================
# NOTES FOR PRODUCTION DEPLOYMENT
# =============================================================================
#
# 1. SECURITY: Enable TLS for both client and peer connections
#    - Generate certificates using a proper CA
#    - Rotate certificates before expiration
#
# 2. PERSISTENCE: Use persistent volumes for /etcd-data
#    - Consider separate fast storage for WAL
#    - Regular backups using etcdctl snapshot save
#
# 3. NETWORKING:
#    - Ensure low latency between etcd nodes (<10ms RTT)
#    - Consider dedicated network for etcd traffic
#
# 4. MONITORING:
#    - Scrape /metrics endpoint with Prometheus
#    - Alert on:
#      - etcd_server_has_leader = 0
#      - etcd_server_proposals_failed_total increasing
#      - etcd_disk_wal_fsync_duration_seconds high
#      - etcd_mvcc_db_total_size_in_bytes approaching quota
#
# 5. MAINTENANCE:
#    - Regular compaction (configured above)
#    - Periodic defragmentation: etcdctl defrag
#    - Monitor disk usage and vacuum if needed
#
# 6. BACKUP:
#    - etcdctl snapshot save /backup/etcd-snapshot-$(date +%Y%m%d).db
#    - Store backups off-cluster
#    - Test restoration periodically
#
# Example backup script:
# ```
# #!/bin/bash
# ENDPOINTS="etcd1:2379,etcd2:2379,etcd3:2379"
# BACKUP_DIR="/backup/etcd"
# DATE=$(date +%Y%m%d-%H%M%S)
# etcdctl --endpoints=$ENDPOINTS snapshot save $BACKUP_DIR/snapshot-$DATE.db
# ```
