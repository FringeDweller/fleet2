# Fleet2 Prometheus Recording and Alert Rules
# This file is loaded by Prometheus via rule_files config

groups:
  # Recording rules for pre-calculating frequently used queries
  - name: fleet2_recording_rules
    interval: 30s
    rules:
      # Request rate per second (5 minute average)
      - record: fleet2:http_requests:rate5m
        expr: sum(rate(http_requests_total{app="fleet2"}[5m])) by (instance, method, path)

      # Error rate percentage
      - record: fleet2:http_errors:rate5m
        expr: |
          sum(rate(http_requests_total{app="fleet2",status=~"5.."}[5m])) by (instance)
          /
          sum(rate(http_requests_total{app="fleet2"}[5m])) by (instance)
          * 100

      # Request duration percentiles
      - record: fleet2:http_request_duration:p50
        expr: histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket{app="fleet2"}[5m])) by (le, instance))

      - record: fleet2:http_request_duration:p95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{app="fleet2"}[5m])) by (le, instance))

      - record: fleet2:http_request_duration:p99
        expr: histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{app="fleet2"}[5m])) by (le, instance))

      # Database connection pool utilization
      - record: fleet2:db_pool_utilization:ratio
        expr: |
          db_connections_active{app="fleet2"}
          /
          (db_connections_active{app="fleet2"} + db_connections_idle{app="fleet2"})

      # Memory utilization percentage
      - record: fleet2:memory_utilization:ratio
        expr: |
          nodejs_heap_size_used_bytes{app="fleet2"}
          /
          nodejs_heap_size_total_bytes{app="fleet2"}

  # Critical alerts - require immediate attention
  - name: fleet2_critical_alerts
    rules:
      - alert: InstanceDown
        expr: up{job="fleet2-app"} == 0
        for: 2m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Fleet2 instance {{ $labels.instance }} is down"
          description: "Instance {{ $labels.instance }} has been unreachable for more than 2 minutes."
          runbook_url: "https://wiki.example.com/runbooks/instance-down"

      - alert: HighErrorRate
        expr: fleet2:http_errors:rate5m > 10
        for: 5m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "High error rate on Fleet2"
          description: "Error rate is {{ $value | printf \"%.2f\" }}% on instance {{ $labels.instance }}."
          runbook_url: "https://wiki.example.com/runbooks/high-error-rate"

      - alert: DatabaseDown
        expr: pg_up{job="postgresql"} == 0
        for: 1m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "PostgreSQL database is down"
          description: "PostgreSQL database is unreachable for more than 1 minute."
          runbook_url: "https://wiki.example.com/runbooks/database-down"

      - alert: RedisDown
        expr: redis_up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Redis is down"
          description: "Redis is unreachable for more than 1 minute."
          runbook_url: "https://wiki.example.com/runbooks/redis-down"

      - alert: HighMemoryUsage
        expr: fleet2:memory_utilization:ratio > 0.9
        for: 5m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory utilization is {{ $value | printf \"%.2f\" }}% on instance {{ $labels.instance }}."
          runbook_url: "https://wiki.example.com/runbooks/high-memory"

      - alert: AllInstancesDown
        expr: count(up{job="fleet2-app"} == 1) == 0
        for: 1m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "All Fleet2 instances are down"
          description: "No Fleet2 application instances are responding. Complete service outage."
          runbook_url: "https://wiki.example.com/runbooks/complete-outage"

  # Warning alerts - require attention but not immediate
  - name: fleet2_warning_alerts
    rules:
      - alert: HighLatency
        expr: fleet2:http_request_duration:p95 > 2
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "High latency on Fleet2"
          description: "95th percentile latency is {{ $value | printf \"%.2f\" }}s on instance {{ $labels.instance }}."
          runbook_url: "https://wiki.example.com/runbooks/high-latency"

      - alert: HighCPUUsage
        expr: |
          rate(process_cpu_seconds_total{job="fleet2-app"}[5m]) * 100 > 80
        for: 10m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ $value | printf \"%.2f\" }}% on instance {{ $labels.instance }}."
          runbook_url: "https://wiki.example.com/runbooks/high-cpu"

      - alert: DiskSpaceLow
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 20
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Low disk space on host"
          description: "Only {{ $value | printf \"%.2f\" }}% disk space remaining."
          runbook_url: "https://wiki.example.com/runbooks/disk-space"

      - alert: DatabasePoolExhausted
        expr: fleet2:db_pool_utilization:ratio > 0.9
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Database connection pool near exhaustion"
          description: "Connection pool is {{ $value | printf \"%.2f\" }}% utilized on instance {{ $labels.instance }}."
          runbook_url: "https://wiki.example.com/runbooks/db-pool-exhaustion"

      - alert: HighRequestRate
        expr: sum(rate(http_requests_total{app="fleet2"}[5m])) > 1000
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Unusually high request rate"
          description: "Request rate is {{ $value | printf \"%.0f\" }} requests/second."
          runbook_url: "https://wiki.example.com/runbooks/high-traffic"

      - alert: SlowDatabaseQueries
        expr: histogram_quantile(0.95, rate(db_query_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Slow database queries detected"
          description: "95th percentile query duration is {{ $value | printf \"%.2f\" }}s."
          runbook_url: "https://wiki.example.com/runbooks/slow-queries"

      - alert: InstanceDegraded
        expr: count(up{job="fleet2-app"} == 1) < 3
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Fleet2 is running in degraded mode"
          description: "Only {{ $value }} instances are healthy. Expected 3."
          runbook_url: "https://wiki.example.com/runbooks/degraded-state"

  # Info alerts - notifications only
  - name: fleet2_info_alerts
    rules:
      - alert: DeploymentDetected
        expr: changes(process_start_time_seconds{job="fleet2-app"}[10m]) > 0
        labels:
          severity: info
          team: platform
        annotations:
          summary: "Fleet2 deployment detected"
          description: "Instance {{ $labels.instance }} was restarted/deployed."

      - alert: CertificateExpiryWarning
        expr: |
          (probe_ssl_earliest_cert_expiry - time()) / 86400 < 30
        for: 1h
        labels:
          severity: info
          team: platform
        annotations:
          summary: "SSL certificate expiring soon"
          description: "Certificate expires in {{ $value | printf \"%.0f\" }} days."
          runbook_url: "https://wiki.example.com/runbooks/cert-renewal"
