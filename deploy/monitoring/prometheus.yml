# Prometheus Configuration for Fleet2
# Usage: Part of monitoring stack in deploy/docker-compose.monitoring.yml

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    monitor: 'fleet2-monitor'
    environment: 'production'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# Load rules
rule_files:
  - /etc/prometheus/rules/*.yml

# Scrape configurations
scrape_configs:
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Fleet2 Application Metrics
  - job_name: 'fleet2-app'
    metrics_path: /api/metrics
    static_configs:
      - targets:
          - 'app1:3000'
          - 'app2:3000'
          - 'app3:3000'
        labels:
          app: 'fleet2'
          environment: 'production'
    relabel_configs:
      - source_labels: [__address__]
        regex: '(.+):.*'
        target_label: instance
        replacement: '${1}'
    # Optional: Add basic auth if metrics endpoint is protected
    # basic_auth:
    #   username: prometheus
    #   password_file: /etc/prometheus/secrets/metrics_password

  # Fleet2 Health Endpoint
  - job_name: 'fleet2-health'
    metrics_path: /api/health
    static_configs:
      - targets:
          - 'app1:3000'
          - 'app2:3000'
          - 'app3:3000'
    scrape_interval: 30s
    scrape_timeout: 10s

  # Nginx metrics (requires nginx-prometheus-exporter)
  - job_name: 'nginx'
    static_configs:
      - targets: ['nginx-exporter:9113']
        labels:
          app: 'nginx'

  # PostgreSQL metrics (requires postgres_exporter)
  - job_name: 'postgresql'
    static_configs:
      - targets: ['postgres-exporter:9187']
        labels:
          app: 'postgresql'

  # Redis metrics (requires redis_exporter)
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
        labels:
          app: 'redis'

  # Node exporter for host metrics
  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']
        labels:
          app: 'host'

  # Container metrics via cAdvisor
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']

---
# Recording Rules - save to /etc/prometheus/rules/recording.yml
# These pre-calculate frequently used queries for dashboard performance

groups:
  - name: fleet2_recording_rules
    interval: 30s
    rules:
      # Request rate per second (5 minute average)
      - record: fleet2:http_requests:rate5m
        expr: sum(rate(http_requests_total{app="fleet2"}[5m])) by (instance, method, path)

      # Error rate percentage
      - record: fleet2:http_errors:rate5m
        expr: |
          sum(rate(http_requests_total{app="fleet2",status=~"5.."}[5m])) by (instance)
          /
          sum(rate(http_requests_total{app="fleet2"}[5m])) by (instance)
          * 100

      # Request duration percentiles
      - record: fleet2:http_request_duration:p50
        expr: histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket{app="fleet2"}[5m])) by (le, instance))

      - record: fleet2:http_request_duration:p95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{app="fleet2"}[5m])) by (le, instance))

      - record: fleet2:http_request_duration:p99
        expr: histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{app="fleet2"}[5m])) by (le, instance))

      # Database connection pool utilization
      - record: fleet2:db_pool_utilization:ratio
        expr: |
          db_connections_active{app="fleet2"}
          /
          (db_connections_active{app="fleet2"} + db_connections_idle{app="fleet2"})

      # Memory utilization percentage
      - record: fleet2:memory_utilization:ratio
        expr: |
          nodejs_heap_size_used_bytes{app="fleet2"}
          /
          nodejs_heap_size_total_bytes{app="fleet2"}

---
# Alert Rules - save to /etc/prometheus/rules/alerts.yml

groups:
  - name: fleet2_critical_alerts
    rules:
      # Instance down alert
      - alert: InstanceDown
        expr: up{job="fleet2-app"} == 0
        for: 2m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Fleet2 instance {{ $labels.instance }} is down"
          description: "Instance {{ $labels.instance }} has been unreachable for more than 2 minutes."
          runbook_url: "https://wiki.example.com/runbooks/instance-down"

      # High error rate
      - alert: HighErrorRate
        expr: fleet2:http_errors:rate5m > 10
        for: 5m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "High error rate on Fleet2"
          description: "Error rate is {{ $value | printf \"%.2f\" }}% on instance {{ $labels.instance }}."
          runbook_url: "https://wiki.example.com/runbooks/high-error-rate"

      # Database connection failure
      - alert: DatabaseDown
        expr: pg_up{job="postgresql"} == 0
        for: 1m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "PostgreSQL database is down"
          description: "PostgreSQL database is unreachable for more than 1 minute."
          runbook_url: "https://wiki.example.com/runbooks/database-down"

      # Redis connection failure
      - alert: RedisDown
        expr: redis_up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Redis is down"
          description: "Redis is unreachable for more than 1 minute."
          runbook_url: "https://wiki.example.com/runbooks/redis-down"

      # High memory usage
      - alert: HighMemoryUsage
        expr: fleet2:memory_utilization:ratio > 0.9
        for: 5m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "High memory usage on {{ $labels.instance }}"
          description: "Memory utilization is {{ $value | printf \"%.2f\" }}% on instance {{ $labels.instance }}."
          runbook_url: "https://wiki.example.com/runbooks/high-memory"

      # All instances down
      - alert: AllInstancesDown
        expr: count(up{job="fleet2-app"} == 1) == 0
        for: 1m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "All Fleet2 instances are down"
          description: "No Fleet2 application instances are responding. Complete service outage."
          runbook_url: "https://wiki.example.com/runbooks/complete-outage"

  - name: fleet2_warning_alerts
    rules:
      # High latency
      - alert: HighLatency
        expr: fleet2:http_request_duration:p95 > 2
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "High latency on Fleet2"
          description: "95th percentile latency is {{ $value | printf \"%.2f\" }}s on instance {{ $labels.instance }}."
          runbook_url: "https://wiki.example.com/runbooks/high-latency"

      # High CPU usage
      - alert: HighCPUUsage
        expr: |
          rate(process_cpu_seconds_total{job="fleet2-app"}[5m]) * 100 > 80
        for: 10m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ $value | printf \"%.2f\" }}% on instance {{ $labels.instance }}."
          runbook_url: "https://wiki.example.com/runbooks/high-cpu"

      # Low disk space
      - alert: DiskSpaceLow
        expr: |
          (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 20
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Low disk space on host"
          description: "Only {{ $value | printf \"%.2f\" }}% disk space remaining."
          runbook_url: "https://wiki.example.com/runbooks/disk-space"

      # Database connection pool exhaustion
      - alert: DatabasePoolExhausted
        expr: fleet2:db_pool_utilization:ratio > 0.9
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Database connection pool near exhaustion"
          description: "Connection pool is {{ $value | printf \"%.2f\" }}% utilized on instance {{ $labels.instance }}."
          runbook_url: "https://wiki.example.com/runbooks/db-pool-exhaustion"

      # High request rate (potential DDoS or traffic spike)
      - alert: HighRequestRate
        expr: sum(rate(http_requests_total{app="fleet2"}[5m])) > 1000
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Unusually high request rate"
          description: "Request rate is {{ $value | printf \"%.0f\" }} requests/second."
          runbook_url: "https://wiki.example.com/runbooks/high-traffic"

      # Slow database queries
      - alert: SlowDatabaseQueries
        expr: histogram_quantile(0.95, rate(db_query_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Slow database queries detected"
          description: "95th percentile query duration is {{ $value | printf \"%.2f\" }}s."
          runbook_url: "https://wiki.example.com/runbooks/slow-queries"

      # One instance down (degraded state)
      - alert: InstanceDegraded
        expr: count(up{job="fleet2-app"} == 1) < 3
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Fleet2 is running in degraded mode"
          description: "Only {{ $value }} instances are healthy. Expected 3."
          runbook_url: "https://wiki.example.com/runbooks/degraded-state"

  - name: fleet2_info_alerts
    rules:
      # Deployment detected
      - alert: DeploymentDetected
        expr: changes(process_start_time_seconds{job="fleet2-app"}[10m]) > 0
        labels:
          severity: info
          team: platform
        annotations:
          summary: "Fleet2 deployment detected"
          description: "Instance {{ $labels.instance }} was restarted/deployed."

      # Certificate expiry warning (30 days)
      - alert: CertificateExpiryWarning
        expr: |
          (probe_ssl_earliest_cert_expiry - time()) / 86400 < 30
        for: 1h
        labels:
          severity: info
          team: platform
        annotations:
          summary: "SSL certificate expiring soon"
          description: "Certificate expires in {{ $value | printf \"%.0f\" }} days."
          runbook_url: "https://wiki.example.com/runbooks/cert-renewal"
